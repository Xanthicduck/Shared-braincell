// index.js

// Load environment variables from .env file
require('dotenv').config();

// Get the necessary classes from the discord.js library
const { Client, GatewayIntentBits } = require('discord.js');

// --- Configuration ---

const DISCORD_TOKEN = process.env.DISCORD_TOKEN;
const TENOR_API_KEY = process.env.TENOR_API_KEY;

// Bot settings
const COMMAND_PREFIX = '!';
const GIF_SEARCH_TERM = 'shared braincell';
const LIMIT = 20; // Number of GIFs to fetch from Tenor

// Ensure a Discord token is provided
if (!DISCORD_TOKEN) {
    console.error('FATAL ERROR: DISCORD_TOKEN not found. Check your .env file.');
    process.exit(1);
}

// Create a new client instance with necessary Intents
const client = new Client({ 
    intents: [
        GatewayIntentBits.Guilds,
        GatewayIntentBits.GuildMessages,
        GatewayIntentBits.MessageContent, // REQUIRED to read message content
    ] 
});

/**
 * Fetches a list of GIFs from Tenor and returns a random GIF URL.
 * @param {string} searchTerm 
 * @param {number} limit 
 * @returns {Promise<string|null>} The GIF URL or null if failed.
 */
async function getRandomTenorGif(searchTerm, limit) {
    if (!TENOR_API_KEY) {
        console.error('Tenor API Key is missing!');
        return null;
    }
    
    const encoded = encodeURIComponent(searchTerm);
    const url = `https://tenor.googleapis.com/v2/search?q=${encoded}&key=${TENOR_API_KEY}&client_key=my_js_bot&limit=${limit}&media_filter=minimal`;
    
    try {
        if (typeof fetch === 'undefined') {
            console.warn('Global fetch is not available. Install node-fetch@2 or run on Node 18+');
        }
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        if (data && data.results && data.results.length > 0) {
            // Select a random GIF from the results array
            const randomIndex = Math.floor(Math.random() * data.results.length);
            const randomGif = data.results[randomIndex];
            
            // Get the URL from the 'minimal' media format (defensive)
            const gifUrl = randomGif?.media_formats?.minimal?.url ?? null;
            return gifUrl;
        } else {
            console.log('Tenor search returned no results.');
            return null;
        }
        
    } catch (error) {
        console.error(`Error fetching GIF from Tenor: ${error.message}`);
        return null;
    }
}


// --- Events ---

// When the client is ready, run this once
client.once('ready', () => {
    console.log(`ðŸ¤– Bot Logged in as: ${client.user.tag}`);
    console.log('-------------------------------------------');
    client.user.setActivity('Waiting for the braincell...');
});

// Listen for messages in channels
client.on('messageCreate', async message => {
    // Ignore messages from the bot itself
    if (message.author.bot) return;

    // The full command should be case-insensitive
    const fullCommand = message.content.toLowerCase().trim();

    // Check if the message starts with the command or its alias
    if (fullCommand === `${COMMAND_PREFIX}sharedbraincell` || fullCommand === `${COMMAND_PREFIX}sbc`) {
        
        // Let the user know the bot is working
        try {
            await message.channel.sendTyping();
        } catch (err) {
            // ignore typing errors
        }

        if (TENOR_API_KEY === 'YOUR_TENOR_API_KEY_HERE' || !TENOR_API_KEY) {
            return message.channel.send('ðŸš¨ **ERROR:** Please set your `TENOR_API_KEY` in the `.env` file to enable GIF fetching!');
        }
        
        console.log('Command detected. Fetching GIF...');

        const gifUrl = await getRandomTenorGif(GIF_SEARCH_TERM, LIMIT);
        
        if (gifUrl) {
            // Send the GIF URL. Discord will automatically embed it.
            message.channel.send(gifUrl).catch(err => console.error('Failed to send message:', err.message));
        } else {
            // Fallback message
            message.channel.send('The single shared braincell is currently offline. Cannot find a GIF.').catch(err => console.error('Failed to send message:', err.message));
        }
    }
});


// Log in to Discord with your client's token
client.login(DISCORD_TOKEN).catch(err => {
    console.error('ERROR: Failed to log in. The token in your .env file is likely invalid.');
    console.error(err.message);
});
